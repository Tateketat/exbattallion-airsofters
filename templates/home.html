{% extends "base.html" %}
{% block title %}ExBattallion Airsofters{% endblock %}
{% block head %}
<link href="https://fonts.googleapis.com/css2?family=Oswald:wght@700&display=swap" rel="stylesheet">
<style>
  body {
    background: #222 url("{{ url_for('static', filename='images/background.jpg') }}") repeat !important;
    background-size: cover !important;
    padding-bottom: 42px; /* Reserve space for sticky footer */
  }
  .mil-gallery-grid {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 4px;
    padding: 0 2px;
  }
  @media (max-width: 1200px) {
    .mil-gallery-grid {
      grid-template-columns: repeat(4, 1fr);
    }
  }
  @media (max-width: 900px) {
    .mil-gallery-grid {
      grid-template-columns: repeat(3, 1fr);
    }
  }
  @media (max-width: 600px) {
    .mil-gallery-grid {
      grid-template-columns: repeat(3, 1fr);
      gap: 2px;
    }
    .mil-card { margin-bottom: 1px !important; }
    .mil-card .mil-img { aspect-ratio: 9 / 16; height: auto; }
    .mil-badge, .mil-role-badge, .mil-unit-badge { font-size: .50em !important; padding: 0.08em 0.22em !important; }
    body {
      background-attachment: fixed !important;
      background-position: center center !important;
      background-repeat: no-repeat !important;
      background-size: cover !important;
    }
  }
  .mil-card {
    background: rgba(30,40,30,0.86);
    border: 1px solid #7b8f62;
    border-radius: 3.5px;
    box-shadow: 0 1px 2px #141e14;
    font-family: 'Oswald', Impact, sans-serif;
    color: #d7dfc7;
    margin-bottom: .4rem;
    overflow: hidden;
    position: relative;
    padding: 0;
  }
  .mil-card .mil-img {
    width: 100%;
    aspect-ratio: 9 / 16;
    height: auto;
    min-height: 90px;
    object-fit: cover;
    border-bottom: 1px solid #7b8f62;
    background: #272c2a;
    display: block;
    max-width: 100%;
    cursor: zoom-in;
    transition: box-shadow 0.2s;
  }
  .mil-card .mil-img:hover {
    box-shadow: 0 0 10px 2px #b7ffbe88;
  }
  /* BADGES CONTAINER WRAPPED BOX */
  .mil-badges {
    display: inline-flex;
    gap: 2px;
    background: rgba(60,70,60,0.78);
    border-radius: 14px;
    padding: 2.5px 7px;
    margin: .10em auto .11em auto;
    box-shadow: 0 1px 3px #0002;
    align-items: center;
    justify-content: center;
  }
  .mil-badge {
    background: #556b2f;
    color: #fff;
    border-radius: 2px;
    font-size: 0.63em;
    font-family: 'Oswald', Impact, sans-serif;
    padding: 0.11em 0.31em;
    display: inline-block;
    letter-spacing: 0.3px;
    border: none;
    white-space: nowrap;
  }
  .mil-role-badge {
    background: #324e2a;
  }
  .mil-unit-badge {
    background: #324e2a;
    color: #fff;
    border-radius: 2px;
    font-size: 0.63em;
    font-family: 'Oswald', Impact, sans-serif;
    padding: 0.11em 0.31em;
    display: inline-block;
    letter-spacing: 0.3px;
    border: none;
    cursor: pointer;
    text-transform: uppercase;
    font-weight: bold;
    transition: background 0.18s;
    white-space: nowrap;
  }
  .mil-unit-badge:hover {
    background: #1e90ff;
    color: #eafffb;
  }
  /* Sticky footer styles */
  .site-footer {
    position: fixed;
    left: 0;
    bottom: 0;
    width: 100vw;
    z-index: 100;
    background: rgba(30,40,30,0.95);
    border-top: 1.5px solid #7b8f62;
    padding: 7px 0 6px 0;
    box-shadow: 0 -2px 10px #0002;
  }
  /* Lightbox modal custom style */
  #imgModal .modal-content {
    background: #181a1b;
    border: 2px solid #b7ffbe;
    border-radius: 12px;
    text-align: center;
    position: relative;
  }
  #imgModal .close {
    position: absolute;
    top: 7px;
    right: 15px;
    font-size: 2rem;
    color: #b7ffbe;
    cursor: pointer;
    z-index: 1002;
    background: none;
    border: none;
    opacity: 1;
  }
</style>
{% endblock %}
{% block content %}

<!-- Header with title and Add Loadout button only (no logo) -->
<div class="d-flex justify-content-between align-items-center mb-2">
  <h2 style="font-family:'Oswald',Impact,sans-serif;letter-spacing:1px;color:#b7ffbe;font-size:1.13rem;">LOADOUT GALLERY</h2>
  {% if session.get('user_id') %}
    <a href="{{ url_for('add_loadout') }}" class="btn btn-success btn-sm" style="font-family:'Oswald',Impact,sans-serif;letter-spacing:1px;">+ Add Loadout</a>
  {% endif %}
</div>

{% if loadouts %}
  <div class="mil-gallery-grid">
    {% for l in loadouts %}
    {% set user = get_user(l.user_id) %}
      <div class="mil-card position-relative h-100">
        {% if l.images and l.images[0] %}
          <img src="{{ url_for('uploaded_file', filename=l.images[0].image_path) }}" class="mil-img" alt="Loadout Image" onclick="openModal(this.src)">
        {% else %}
          <img src="https://via.placeholder.com/360x640/222/556b2f?text=No+Image" class="mil-img" alt="No image" onclick="openModal(this.src)">
        {% endif %}
        <div class="d-flex justify-content-center pt-1 pb-1">
          <div class="mil-badges">
            <span class="mil-badge"><i class="bi bi-person-badge"></i> {{ user.callsign or 'No Callsign' }}</span>
            <span class="mil-badge mil-role-badge"><i class="bi bi-person-fill"></i> {{ user.role or 'No Role' }}</span>
            <button
              type="button"
              class="mil-unit-badge"
              data-bs-toggle="modal"
              data-bs-target="#unitModal{{ l.id }}"
              title="View Unit (Baril)"
            >
              CLICK HERE
            </button>
          </div>
        </div>
      </div>
    {% endfor %}
  </div>
  <!-- Modals for AEG/Unit images -->
  {% for l in loadouts %}
    {% set user = get_user(l.user_id) %}
    <div class="modal fade" id="unitModal{{ l.id }}" tabindex="-1" aria-labelledby="unitModalLabel{{ l.id }}" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="background:#222c35;color:#fff;">
          <div class="modal-header">
            <h5 class="modal-title" id="unitModalLabel{{ l.id }}">
              Unit used by {{ user.callsign or user.email or 'User' }}
            </h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body text-center">
            {% if l.aeg_image %}
              <img src="{{ url_for('uploaded_file', filename=l.aeg_image) }}" alt="AEG Image" class="img-fluid rounded border mb-2" style="max-height:350px;">
            {% else %}
              <div class="text-muted">No UNIT (AEG/baril) picture uploaded.</div>
            {% endif %}
            <div class="mt-2">
              <span class="mil-badge"><i class="bi bi-person-badge"></i> {{ user.callsign or 'No Callsign' }}</span>
              <span class="mil-badge mil-role-badge"><i class="bi bi-person-fill"></i> {{ user.role or 'No Role' }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  {% endfor %}
{% else %}
  <div class="alert alert-warning">No loadouts yet.</div>
{% endif %}

<!-- Lightbox Modal for gallery image click -->
<div class="modal fade" id="imgModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <button class="close" onclick="closeModal()" aria-label="Close">&times;</button>
      <img id="modalImg" style="width:100%;max-height:70vh;object-fit:contain;">
    </div>
  </div>
</div>

<footer class="site-footer">
  <div style="text-align:center; color:#b7ffbe; font-size:0.95em; font-family:'Oswald',Impact,sans-serif; letter-spacing:1px;">
    &copy; 2025 ExBattallion Airsofters.
  </div>
</footer>
{% endblock %}

{% block scripts %}
<script>
window.addEventListener('DOMContentLoaded', function() {
  setTimeout(function() {
    document.querySelectorAll('.alert').forEach(function(alert) {
      if (alert.classList.contains('show')) {
        var alertInstance = bootstrap.Alert.getOrCreateInstance(alert);
        alertInstance.close();
      }
    });
  }, 2500);
});

// Lightbox modal JS
function openModal(src) {
  document.getElementById('modalImg').src = src;
  var modal = new bootstrap.Modal(document.getElementById('imgModal'), {});
  modal.show();
}
function closeModal() {
  var modalEl = document.getElementById('imgModal');
  var modal = bootstrap.Modal.getInstance(modalEl);
  modal.hide();
}
</script>
{% endblock %}